<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Libros Ecuador 2025</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="index.css" />
</head>

<body>

  <header>
    <div class="header-inner">
      <div class="header-text">
        <h1>Observatorio del Libro UCE</h1>
        <p class="subtitle">Universidad Central del Ecuador · Libros, precios y territorio</p>
        <div class="header-meta">
          Proyecto académico para analizar la red de librerías y el acceso al libro en Ecuador.
        </div>
      </div>
      <div class="header-badges">
        <span class="pill pill-accent">Trabajo de titulación UCE</span>
        <span class="pill">Cobertura nacional en construcción</span>
        <button class="presentation-toggle" onclick="togglePresentacion()">Modo presentación</button>
      </div>
    </div>
  </header>

    <div class="tabs">
    <div class="tab active" onclick="openTab('dashboard')">Panorama nacional</div>
    <div class="tab" onclick="openTab('catalogo')">Catálogo de libros</div>
    <div class="tab" onclick="openTab('metodologia')">Metodología UCE</div>
  </div>

  <div class="container">
    <div id="dashboard" class="tab-content active">
      <div class="loading">Cargando datos…</div>
    </div>
    <div id="catalogo" class="tab-content">
      <div class="loading">Preparando catálogo…</div>
    </div>
    <div id="metodologia" class="tab-content">
      <div class="section metodologia-section">
        <h2>Metodología del Observatorio UCE</h2>
        <p class="metodologia-intro">
          Este observatorio combina datos oficiales del Servicio de Rentas Internas (SRI) con librerías geolocalizadas en Google Maps para evaluar la disponibilidad real de libros en Ecuador.
        </p>
        <div class="metodologia-grid">
          <div class="metodologia-card">
            <h3>Fuentes de datos</h3>
            <ul>
              <li>Registros oficiales del SRI por provincia y zona.</li>
              <li>Librerías y papelerías detectadas en Google Maps.</li>
              <li>Precios reales de catálogos comerciales de librerías.</li>
            </ul>
          </div>
          <div class="metodologia-card">
            <h3>Fecha de corte</h3>
            <p>
              Los datos utilizados corresponden al año 2025. Nuevos JSON por provincia (por ejemplo precios_pichincha.json, ubicaciones_pichincha.json o precios_azuay.json) pueden incorporarse para actualizar el análisis sin modificar el código.
            </p>
          </div>
          <div class="metodologia-card">
            <h3>Limitaciones</h3>
            <ul>
              <li>No todas las librerías del país cuentan con presencia digital.</li>
              <li>Los precios pueden cambiar con el tiempo respecto a los catálogos capturados.</li>
              <li>La cobertura por provincia depende de la calidad de los JSON aportados por el equipo.</li>
            </ul>
          </div>
        </div>
        <p class="metodologia-nota">
          La plataforma está pensada como herramienta de apoyo para el análisis académico de la Universidad Central del Ecuador, no como listado comercial definitivo.
        </p>
        <div class="section metodologia-section" style="margin-top:2rem">
          <h2>Modelo heurístico aplicado en el dashboard</h2>
          <p>
            El modelo se usa para sintetizar, por provincia y para el país completo, señales observables del mercado del libro en ausencia de un censo exhaustivo. Se integran la <strong>frecuencia digital de ofertas</strong>, la <strong>presencia territorial de librerías</strong> y el <strong>precio promedio normalizado</strong> en las <strong>24 provincias</strong> del Ecuador.
          </p>
          <h3>Entradas por provincia <em>p</em></h3>
          <ul>
            <li><strong><span class="f-overline">P</span><sub>p</sub></strong>: precio promedio de todas las ofertas de libros en la provincia <em>p</em>.</li>
            <li><strong>O<sub>p</sub></strong>: número total de ofertas (precios capturados) en la provincia <em>p</em>.</li>
            <li><strong>L<sub>p</sub></strong>: número de librerías distintas con al menos un libro en la provincia <em>p</em>.</li>
          </ul>
          <h3>Normalizaciones</h3>
          <ul>
            <li>Provincias: se normaliza el nombre removiendo diacríticos y usando mayúsculas para evitar duplicados.</li>
            <li>Precios: se linealiza el rango [min<sub>P</sub> <span class="f-overline">P</span>, max<sub>P</sub> <span class="f-overline">P</span>] para que precios más bajos incrementen el puntaje.</li>
            <li>Frecuencia y librerías: se escalan a [0, 1] respecto al máximo observado entre provincias.</li>
          </ul>
          <h3>Formulación provincial</h3>
          <div class="formula-block" style="background:#0f172a;color:#e5e7eb;padding:1rem;border-radius:12px;line-height:1.7">
            Sea el conjunto de provincias <em>P</em> y para cada provincia <em>p</em> ∈ <em>P</em>:<br>
            · Precio normalizado:<br>
            <strong>S<sub>precio</sub>(<em>p</em>) = (max<sub>P</sub> <span class="f-overline">P</span><sub>p</sub> − <span class="f-overline">P</span><sub>p</sub>) / (max<sub>P</sub> <span class="f-overline">P</span><sub>p</sub> − min<sub>P</sub> <span class="f-overline">P</span><sub>p</sub>)</strong>, si max ≠ min; en otro caso S<sub>precio</sub>(<em>p</em>) = 1.<br>
            · Frecuencia normalizada:<br>
            <strong>S<sub>ofertas</sub>(<em>p</em>) = O<sub>p</sub> / max<sub>P</sub> O<sub>p</sub></strong> (si max<sub>P</sub> O<sub>p</sub> &gt; 0, en otro caso 0).<br>
            · Presencia de librerías:<br>
            <strong>S<sub>librerías</sub>(<em>p</em>) = L<sub>p</sub> / max<sub>P</sub> L<sub>p</sub></strong> (si max<sub>P</sub> L<sub>p</sub> &gt; 0, en otro caso 0).<br><br>
            Índice heurístico provincial:<br>
            <strong>H<sub>p</sub> = 100 · (0,4·S<sub>precio</sub>(<em>p</em>) + 0,4·S<sub>ofertas</sub>(<em>p</em>) + 0,2·S<sub>librerías</sub>(<em>p</em>))</strong><br>
            donde H<sub>p</sub> ∈ [0, 100]; valores altos indican mejor desempeño relativo (precios competitivos, alta oferta y diversidad de librerías).
          </div>
          <h3>Índice heurístico nacional</h3>
          <div class="formula-block" style="background:#0f172a;color:#e5e7eb;padding:1rem;border-radius:12px;line-height:1.7;margin-top:1rem">
            Para el país completo se define un promedio ponderado por volumen de ofertas:<br>
            · Peso de la provincia <em>p</em>:<br>
            <strong>w<sub>p</sub> = O<sub>p</sub> / Σ<sub>q ∈ P</sub> O<sub>q</sub></strong> (si Σ<sub>q ∈ P</sub> O<sub>q</sub> &gt; 0).<br>
            · Índice heurístico nacional:<br>
            <strong>H<sub>ECU</sub> = Σ<sub>p ∈ P</sub> w<sub>p</sub> · H<sub>p</sub></strong>, con H<sub>ECU</sub> ∈ [0, 100].<br>
            Este valor resume el desempeño agregado del mercado formal del libro en Ecuador.
          </div>
          <h3>Ejemplo numérico (Pichincha, valores ilustrativos)</h3>
          <p>
            Para fijar la idea, supongamos que tras procesar la base nacional se obtiene el siguiente resumen (números aproximados, solo para ilustrar el cálculo):
          </p>
          <ul>
            <li><strong><span class="f-overline">P</span><sub>Pichincha</sub> = 21,03 USD</strong>, con promedio mínimo y máximo entre provincias <strong>min<sub>P</sub> <span class="f-overline">P</span> = 18,50</strong>, <strong>max<sub>P</sub> <span class="f-overline">P</span> = 35,20</strong>.</li>
            <li><strong>O<sub>Pichincha</sub> = 800</strong> ofertas registradas y <strong>max<sub>P</sub> O = 2100</strong> ofertas en la provincia con mayor actividad.</li>
            <li><strong>L<sub>Pichincha</sub> = 35</strong> librerías distintas y <strong>max<sub>P</sub> L = 70</strong> librerías en la provincia con más establecimientos.</li>
          </ul>
          <p>Con estos datos, los puntajes normalizados son:</p>
          <ul>
            <li><strong>S<sub>precio</sub>(Pichincha) = (max<sub>P</sub> <span class="f-overline">P</span> − <span class="f-overline">P</span><sub>Pichincha</sub>) / (max<sub>P</sub> <span class="f-overline">P</span> − min<sub>P</sub> <span class="f-overline">P</span>)</strong> ≈ (35,20 − 21,03) / (35,20 − 18,50) ≈ 14,17 / 16,70 ≈ <strong>0,848</strong>.</li>
            <li><strong>S<sub>ofertas</sub>(Pichincha) = O<sub>Pichincha</sub> / max<sub>P</sub> O</strong> = 800 / 2100 ≈ <strong>0,381</strong>.</li>
            <li><strong>S<sub>librerías</sub>(Pichincha) = L<sub>Pichincha</sub> / max<sub>P</sub> L</strong> = 35 / 70 = <strong>0,50</strong>.</li>
          </ul>
          <p>Finalmente, el índice heurístico provincial para Pichincha se calcula como:</p>
          <div class="formula-block" style="background:#0f172a;color:#e5e7eb;padding:1rem;border-radius:12px;line-height:1.7">
            H<sub>Pichincha</sub> = 100 · (0,4·0,848 + 0,4·0,381 + 0,2·0,50)<br>
            ≈ 100 · (0,339 + 0,152 + 0,100)<br>
            ≈ 100 · 0,591 ≈ <strong>59,1 puntos</strong> (escala 0–100).<br>
            Este valor es comparable con el H<sub>p</sub> del resto de provincias y con el H<sub>ECU</sub> nacional mostrado en el dashboard.
          </div>
          <div class="section metodologia-section" id="met-ej-dinamico" style="margin-top:1rem">
            <h3>Ejemplo dinámico con valores actuales (provincia seleccionada)</h3>
            <div class="kpi-filter-bar">
              <div class="kpi-filter-label">Analizar datos de</div>
              <select id="provinciaKpiSelectMet" class="provincia-select"></select>
            </div>
            <div id="met-ej-dinamico-body">
              <p style="color:#9ca3af">Se actualizará automáticamente cuando cambies la provincia en el selector del dashboard.</p>
            </div>
          </div>
          <div class="section metodologia-section" id="met-conclusion" style="margin-top:1rem">
            <h3>Conclusión</h3>
            <div id="met-conclusion-body">
              <p style="color:#9ca3af">Se mostrará la interpretación del índice heurístico con el valor actual.</p>
              <ul>
                <li>Cerca de 0 → mercado formal muy débil: caro, poco denso y poco diverso.</li>
                <li>Cerca de 100 → mercado formal muy fuerte: precios competitivos, muchas ofertas y muchas librerías.</li>
              </ul>
            </div>
          </div>
          <h3>Relación con los KPIs del dashboard</h3>
          <ul>
            <li><strong>Libros únicos</strong>: número de títulos distintos después de agrupar por título y librería.</li>
            <li><strong>Precio promedio</strong>: promedio simple de los precios de las ofertas filtradas (base para <span class="f-overline">P</span><sub>p</sub>).</li>
            <li><strong>Más barato / Más caro</strong>: mínimo y máximo de la distribución de precios en la vista actual.</li>
            <li><strong>Provincias con datos</strong>: cardinalidad de {<em>p</em> ∈ <em>P</em> : O<sub>p</sub> &gt; 0}.</li>
            <li><strong>Índice heurístico</strong>: valor H<sub>ECU</sub> mostrado en el KPI nacional e interpretado en las conclusiones rápidas.</li>
          </ul>
          <h3>Interpretación</h3>
          <ul>
            <li>H<sub>p</sub> permite comparar provincias en un espacio común de 0 a 100, combinando precio, intensidad de mercado y presencia de librerías.</li>
            <li>H<sub>ECU</sub> sintetiza el estado del país ponderando por volumen de actividad, y sirve como indicador global de acceso relativo al libro.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div class="back-top" id="backTop" onclick="window.scrollTo({top:0,behavior:'smooth'})">
    <i class="fas fa-arrow-up"></i>
  </div>

  <div id="modal" class="modal" onclick="if(event.target===this)this.style.display='none'">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitulo">Libro</h2>
        <span class="close" onclick="document.getElementById('modal').style.display='none'">×</span>
      </div>
      <div class="modal-body">
        <div class="modal-controls">
          <input type="text" id="modalSearch" placeholder="Filtrar librería..." onkeyup="filtrarModal()">
          <select id="modalOrder" onchange="ordenarModal()">
            <option value="precio-asc">Precio: menor → mayor</option>
            <option value="precio-desc">Precio: mayor → menor</option>
          </select>
        </div>
        <table>
          <thead>
            <tr>
              <th>Librería</th>
              <th>Precio</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody id="modalBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    const defaultImg = "https://placehold.co/400x600/cccccc/666666?text=Sin+Portada";
    const CACHE_KEY = "librosEcuador_v43";
    const BUST = `?v=${CACHE_KEY}`;
    const DATA_PATH = "data/";
    const EXTRA_PRECIOS_FILES = [
      "LIBRERIAS_ENRIQUECIDO.json"
    ];
    const EXTRA_UBICACIONES_FILES = [
      "librerias_ecuador_cañar_db.json",
      "librerias_ecuador_tungurahua_db.json",
      "librerias_ecuador_napo_db.json",
      "librerias_ecuador_bolívar_db.json",
      "librerias_ecuador_orellana_db.json",
      "librerias_ecuador_chimborazo_db.json",
      "librerias_ecuador_manabí_db.json",
      "librerias_ecuador_cotopaxi_db.json",
      "librerias_ecuador_imbabura_db.json",
      "librerias_ecuador_santaelena_db.json",
      "librerias_ecuador_loja_db.json",
      "librerias_el_oro_db.json",
      "librerias_galapagos_db.json",
      "librerias_2_zamora_chinchipe.json",
      "librerias_2_morona_santiago.json",
      "librerias_2_sucumbios.json",
      "librerias_2_santo_domingo_tsachilas.json",
      "LOS_RIOS.json",
      "ESMERALDAS_CARCHI.json",
      "AZUAY_GUAYAS.json"
    ];
    const EXTRA_SRI_FILES = [];
    let preciosBase = [], grupoBase = {}, precios = [], grupo = [], ubicaciones = [], provincias = [], provinciaActiva = "TODAS", provinciaKpi = "TODAS", datosSRI = [], mapa, capaGoogle, capaSRI;

    function normalizarProvincia(nombre) {
      return (nombre || "")
        .toString()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .trim()
        .toUpperCase();
    }
    function normalizarTexto(s) {
      return (s ?? "")
        .toString()
        .trim()
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, " ");
    }
    
    // decide la categoría del punto usando keyword_found
    function categoriaDesdeKeyword(keyword_found) {
      const k = normalizarTexto(keyword_found);
    
      // cubre: "librería", "libreria", "librerias", "libreria y papeleria"
      if (k.includes("librer")) return "libreria";
    
      // cubre: "papelería", "papeleria"
      if (k.includes("papeler")) return "papeleria";
    
      // cubre: "bookstore", "book store"
      if (k.includes("bookstore") || k.includes("book store")) return "bookstore";
    
      // si no coincide, lo metemos como "libreria" solo si el nombre sugiere (opcional)
      return "otros";
    }
    
    function filtrosMapaActivos() {
      const cont = document.getElementById("mapFilters");
      if (!cont) return ["libreria", "papeleria", "bookstore"]; // fallback
      return Array.from(cont.querySelectorAll("input[type=checkbox]:checked"))
        .map(i => normalizarTexto(i.value));
    }
    function etiquetaProvincia(codigo) {
      const c = (codigo || "").toString().trim().toUpperCase();
      if (!c) return "";
      return c.charAt(0) + c.slice(1).toLowerCase();
    }

    async function fetchJson(archivo, onProgress) {
      try {
        const r = await fetch(DATA_PATH + archivo + BUST);
        if (onProgress) onProgress();
        if (r.ok) return await r.json();
      } catch (e) { if (onProgress) onProgress(); }
      return null;
    }
  
    async function cargarDatos() {
      const cached = localStorage.getItem(CACHE_KEY);
      if (cached) {
        try {
          const data = JSON.parse(cached);
          datosSRI = data.datosSRI || [];
          procesarDatos(data.destacados || [], data.preciosRaw || [], data.ubicaciones || []);
          return;
        } catch (e) { localStorage.removeItem(CACHE_KEY); }
      }

      const loadingEl = document.getElementById('dashboard');
      let completed = 0;
      const totalFiles = 4 + EXTRA_PRECIOS_FILES.length + EXTRA_UBICACIONES_FILES.length;
      function updateProgress() {
        completed++;
        const small = loadingEl.querySelector('.loading small');
        if (small) small.textContent = `Cargando ${completed}/${totalFiles} archivos…`;
      }

      loadingEl.innerHTML = `<div class="loading">Cargando datos…<br><small>Cargando 0/${totalFiles} archivos…</small></div>`;

      // Fase 1: cargar en paralelo los 4 archivos críticos (incl. SRI para el mapa)
      const [destacados, preciosRawBase, ubicacionesBase, sriData] = await Promise.all([
        fetchJson("libros_imagenes.json", updateProgress),
        fetchJson("librerias_procesadas.json", updateProgress),
        fetchJson("librerias_ecuador_pichincha_pastaza_intermedia.json", updateProgress),
        fetchJson("sri_pichincha_pastaza_coordenadas.json", updateProgress)
      ]);
      datosSRI = Array.isArray(sriData) ? sriData : [];

      let preciosRaw = Array.isArray(preciosRawBase) ? preciosRawBase : null;
      if (!preciosRaw || preciosRaw.length === 0) {
        loadingEl.innerHTML = `<div style="color:red;text-align:center;padding:5rem;font-size:2rem;">No se pudieron cargar los datos de librerías.<br><small style="font-size:1.2rem;color:#4b5563">Asegúrate de abrir el proyecto con un servidor web (por ejemplo <code>python -m http.server</code>) y que los archivos JSON estén en la carpeta <strong>data/</strong>.</small><br><button onclick="location.reload()" style="margin-top:2rem;padding:1rem 2rem;background:#003366;color:white;border:none;border-radius:12px;cursor:pointer">Reintentar</button></div>`;
        return;
      }

      let ubicaciones = Array.isArray(ubicacionesBase) ? ubicacionesBase : [];

      // Mostrar contenido con datos críticos de inmediato (primera pintada rápida)
      procesarDatos(destacados || [], preciosRaw, ubicaciones);

      // Fase 2: cargar el resto de archivos en paralelo y actualizar
      const banner = document.createElement('div');
      banner.className = 'loading-banner';
      banner.id = 'loadingBanner';
      banner.textContent = 'Actualizando datos de todas las provincias…';
      document.body.prepend(banner);

      const extraPreciosPromises = EXTRA_PRECIOS_FILES.map(f => fetchJson(f, updateProgress));
      const extraUbicacionesPromises = EXTRA_UBICACIONES_FILES.map(f => fetchJson(f, updateProgress));
      const [extraPreciosResults, extraUbicacionesResults] = await Promise.all([
        Promise.all(extraPreciosPromises),
        Promise.all(extraUbicacionesPromises)
      ]);

      const b = document.getElementById('loadingBanner');
      if (b) b.remove();

      extraPreciosResults.forEach(extra => { if (Array.isArray(extra)) preciosRaw = preciosRaw.concat(extra); });
      extraUbicacionesResults.forEach(extra => { if (Array.isArray(extra)) ubicaciones = ubicaciones.concat(extra); });

      procesarDatos(destacados || [], preciosRaw, ubicaciones);

      try {
        localStorage.setItem(CACHE_KEY, JSON.stringify({ destacados: destacados || [], preciosRaw, ubicaciones, datosSRI }));
      } catch (e) {
        console.warn("No se pudo guardar caché en localStorage (cuota excedida)", e);
      }
    }

    function procesarDatos(destacados, preciosRaw, ubicacionesGuardadas) {
      ubicaciones = ubicacionesGuardadas;
      preciosBase = preciosRaw.filter(l => {
        const p = Number(l.precio) || 0, t = (l.titulo || "").trim(), lib = (l.libreria || "").toLowerCase();
        return p >= 2 && p <= 120 && t && !/^libro(\s*\d*)?$/i.test(t) && !lib.includes("coral") && !lib.includes("hipermercados") && !lib.includes("tama shop") && !lib.includes("tía conocoto");
      });

      preciosBase.forEach(l => {
        const m = destacados.find(d => d.titulo.toLowerCase().includes(l.titulo.toLowerCase()));
        if (m && m.imagen) l.imagen = m.imagen;
      });

      grupoBase = {};
      const visto = new Set();
      preciosBase.forEach(l => {
        const claveTitulo = l.titulo.trim().toUpperCase();
        const clave = `${claveTitulo}|||${l.libreria}`;
        if (!visto.has(clave)) {
          visto.add(clave);
          if (!grupoBase[claveTitulo]) grupoBase[claveTitulo] = [];
          grupoBase[claveTitulo].push(l);
        }
      });

      const setProvincias = new Set();
      preciosBase.forEach(l => { if (l.provincia) setProvincias.add(normalizarProvincia(l.provincia)); });
      ubicaciones.forEach(l => { if (l.provincia) setProvincias.add(normalizarProvincia(l.provincia)); });
      provincias = Array.from(setProvincias).sort();

      aplicarFiltroKpi();
      window.addEventListener('scroll', () => document.getElementById('backTop').classList.toggle('show', window.scrollY > 500));
    }

    function aplicarFiltroKpi() {
      if (!preciosBase.length) return;
      const filtro = provinciaKpi && provinciaKpi !== "TODAS" ? provinciaKpi : null;

      if (filtro) {
        precios = preciosBase.filter(l => normalizarProvincia(l.provincia || "") === filtro);
      } else {
        precios = [...preciosBase];
      }

      grupo = {};
      const visto = new Set();
      precios.forEach(l => {
        const claveTitulo = l.titulo.trim().toUpperCase();
        const clave = `${claveTitulo}|||${l.libreria}`;
        if (!visto.has(clave)) {
          visto.add(clave);
          if (!grupo[claveTitulo]) grupo[claveTitulo] = [];
          grupo[claveTitulo].push(l);
        }
      });

      renderDashboard();
      renderCatalogo();
    }

    function renderDashboard() {
      const dash = document.getElementById("dashboard");
      const totalUnicos = Object.keys(grupo).length;
      const totalOfertas = precios.length;
      const librerias = [...new Set(precios.map(p => p.libreria))].length;
      const provinciasDetectadas = [...new Set(preciosBase.map(p => normalizarProvincia(p.provincia || "")))].filter(Boolean).length;
      const precioPromedio = precios.length ? (precios.reduce((a, b) => a + b.precio, 0) / precios.length).toFixed(2) : "0.00";
      const precioMin = precios.length ? Math.min(...precios.map(p => p.precio)) : 0;
      const precioMax = precios.length ? Math.max(...precios.map(p => p.precio)) : 0;
      const populares = Object.values(grupo).filter(a => a.length >= 3).length;
      const raros = Object.values(grupo).filter(a => a.length === 1).length;

      const porLibreria = {};
      precios.forEach(l => { if (!porLibreria[l.libreria]) porLibreria[l.libreria] = { s: 0, c: 0 }; porLibreria[l.libreria].s += l.precio; porLibreria[l.libreria].c++; });
      const rankingBaratas = Object.entries(porLibreria).map(([n, d]) => ({ nombre: n, promedio: +(d.s / d.c).toFixed(2), libros: d.c })).sort((a, b) => a.promedio - b.promedio);
      const rankingCaras = [...rankingBaratas].reverse();

      const porProvincia = {};
      preciosBase.forEach(l => {
        const prov = normalizarProvincia(l.provincia || "SIN PROVINCIA");
        if (!porProvincia[prov]) porProvincia[prov] = { s: 0, c: 0, librerias: new Set() };
        porProvincia[prov].s += l.precio;
        porProvincia[prov].c++;
        porProvincia[prov].librerias.add(l.libreria);
      });
      const resumenProvincias = Object.entries(porProvincia).map(([prov, d]) => ({
        provincia: prov,
        promedio: d.c ? d.s / d.c : 0,
        ofertas: d.c,
        librerias: d.librerias.size
      }));

      const heuristicaPorProvincia = {};
      let mejorHeurProv = null;
      let heuristicaNacional = null;
      if (resumenProvincias.length > 0) {
        const minProm = Math.min(...resumenProvincias.map(r => r.promedio));
        const maxProm = Math.max(...resumenProvincias.map(r => r.promedio));
        const maxOfertas = Math.max(...resumenProvincias.map(r => r.ofertas));
        const maxLibreriasProv = Math.max(...resumenProvincias.map(r => r.librerias));
        const totalOfertasAll = resumenProvincias.reduce((a, r) => a + r.ofertas, 0);
        resumenProvincias.forEach(r => {
          const precioScore = maxProm > minProm ? (maxProm - r.promedio) / (maxProm - minProm) : 1;
          const ofertasScore = maxOfertas ? r.ofertas / maxOfertas : 0;
          const libreriasScore = maxLibreriasProv ? r.librerias / maxLibreriasProv : 0;
          const h = 100 * (0.4 * precioScore + 0.4 * ofertasScore + 0.2 * libreriasScore);
          heuristicaPorProvincia[r.provincia] = h;
          if (!mejorHeurProv || h > mejorHeurProv.h) mejorHeurProv = { provincia: r.provincia, h };
        });
        if (totalOfertasAll > 0) {
          let acum = 0;
          resumenProvincias.forEach(r => {
            const w = r.ofertas / totalOfertasAll;
            const h = heuristicaPorProvincia[r.provincia] || 0;
            acum += w * h;
          });
          heuristicaNacional = acum;
        }
      }

      const filtroProvActual = provinciaKpi && provinciaKpi !== "TODAS" ? provinciaKpi : null;
      let indiceHeuristicoActual = null;
      let etiquetaHeuristicaActual = "Ecuador completo";
      if (filtroProvActual && heuristicaPorProvincia[filtroProvActual] != null) {
        indiceHeuristicoActual = heuristicaPorProvincia[filtroProvActual];
        etiquetaHeuristicaActual = etiquetaProvincia(filtroProvActual);
      } else if (heuristicaNacional != null) {
        indiceHeuristicoActual = heuristicaNacional;
      }
      const indiceHeuristicoTexto = indiceHeuristicoActual != null ? indiceHeuristicoActual.toFixed(1) : "–";

      let conclusionesHtml = "";
      if (resumenProvincias.length > 0) {
        const ordenPorPrecio = [...resumenProvincias].sort((a, b) => a.promedio - b.promedio);
        const ordenPorOfertas = [...resumenProvincias].sort((a, b) => b.ofertas - a.ofertas);
        const masBarataProv = ordenPorPrecio[0];
        const masCaraProv = ordenPorPrecio[ordenPorPrecio.length - 1];
        const masOfertasProv = ordenPorOfertas[0];
        const heuristicaHtml = mejorHeurProv
          ? `<li><span class="insights-badge">05</span><span>El índice heurístico nacional del mercado formal del libro es <strong>H<sub>ECU</sub> ≈ ${heuristicaNacional != null ? heuristicaNacional.toFixed(1) : "–"}/100</strong>. La provincia con mejor desempeño relativo es <strong>${etiquetaProvincia(mejorHeurProv.provincia)}</strong> (H<sub>p</sub> ≈ ${mejorHeurProv.h.toFixed(1)}/100).</span></li>`
          : "";
        conclusionesHtml = `
          <ul class="insights-list">
            <li><span class="insights-badge">01</span><span>El análisis incluye datos de <strong>${provinciasDetectadas}</strong> provincias con ofertas de libros registradas.</span></li>
            <li><span class="insights-badge">02</span><span><strong>${etiquetaProvincia(masBarataProv.provincia)}</strong> presenta el precio promedio más bajo (~$${masBarataProv.promedio.toFixed(2)}).</span></li>
            <li><span class="insights-badge">03</span><span><strong>${etiquetaProvincia(masCaraProv.provincia)}</strong> concentra los precios promedio más altos (~$${masCaraProv.promedio.toFixed(2)}).</span></li>
            <li><span class="insights-badge">04</span><span>La provincia con más ofertas registradas es <strong>${etiquetaProvincia(masOfertasProv.provincia)}</strong> con ${masOfertasProv.ofertas.toLocaleString()} precios capturados.</span></li>
            ${heuristicaHtml}
          </ul>
        `;
      }

      const opcionesProvinciaKpi = ["TODAS", ...provincias].map(p => {
        const codigo = p === "TODAS" ? "TODAS" : normalizarProvincia(p);
        const etiqueta = p === "TODAS" ? "Ecuador completo" : etiquetaProvincia(codigo);
        return `<option value="${codigo}">${etiqueta}</option>`;
      }).join("");

      dash.innerHTML = `
      <div class="kpi-filter-bar">
        <div class="kpi-filter-label">Analizar datos de</div>
        <select id="provinciaKpiSelect" class="provincia-select">
          ${opcionesProvinciaKpi}
        </select>
      </div>

      <div class="kpi-grid">
        <div class="kpi-card"><h3>Libros únicos</h3><p>${totalUnicos.toLocaleString()}</p></div>
        <div class="kpi-card success"><h3>Precio promedio</h3><p>$${precioPromedio}</p></div>
        <div class="kpi-card"><h3>Más barato</h3><p>$${precioMin}</p></div>
        <div class="kpi-card danger"><h3>Más caro</h3><p>$${precioMax}</p></div>
        <div class="kpi-card warning"><h3>Provincias con datos</h3><p>${provinciasDetectadas}</p></div>
        <div class="kpi-card"><h3>Índice heurístico</h3><p>${indiceHeuristicoTexto}</p><small style="display:block;font-size:.75rem;color:#9ca3af;">${etiquetaHeuristicaActual}</small></div>
      </div>

      <div class="section">
        <h2>Conclusiones rápidas para el trabajo UCE</h2>
        ${conclusionesHtml || `<p style="color:#64748b">Cuando se carguen datos de varias provincias, aquí aparecerá un resumen automático de hallazgos.</p>`}
      </div>

      

      <div class="section"><h2>Top 15 Libros Más Populares</h2><div class="books-grid" id="topGrid"></div></div>
      <div class="section">
        <div class="section-header-row">
          <h2>Librerías Más Baratas</h2>
          <button class="csv-button" id="csvBaratas">Descargar CSV</button>
        </div>
        <table><thead><tr><th>#</th><th>Librería</th><th>Precio Prom.</th><th>Libros</th></tr></thead><tbody id="baratasBody"></tbody><tr class="ver-mas" id="verMasBaratas"><td colspan="4">Mostrar todas</td></tr></table>
      </div>
      <div class="section"><h2>Librerías Más Caras</h2><table><thead><tr><th>#</th><th>Librería</th><th>Precio Prom.</th><th>Libros</th></tr></thead><tbody id="carasBody"></tbody><tr class="ver-mas" id="verMasCaras"><td colspan="4">Mostrar más</td></tr></table></div>
      <div class="section"><h2>Top 15 Libros Más Baratos</h2><table><thead><tr><th>Título</th><th>Precio</th><th>Librería</th></tr></thead><tbody id="cheapestBody"></tbody><tr class="ver-mas" id="verMasCheapest"><td colspan="3">Ver más ofertas</td></tr></table></div>

      <div class="section">
        <h2>Mapa de librerías por provincia (Google Maps + SRI)</h2>
        <div class="provincia-controls">
          <span class="provincia-label">Vista geográfica:</span>
          <select id="provinciaSelect" class="provincia-select"></select>
        </div>
<div class="map-filters" id="mapFilters">
  <span class="provincia-label">Filtrar tipo:</span>

  <label class="chip">
    <input type="checkbox" value="libreria" checked>
    Librería
  </label>

  <label class="chip">
    <input type="checkbox" value="papeleria" checked>
    Papelería
  </label>

  <label class="chip">
    <input type="checkbox" value="bookstore" checked>
    Bookstore
  </label>
</div>



        <div class="leyenda">
          <strong>Leyenda:</strong><br>
          <span style="color:#1e40af">Marcadores azules</span> → Librerías reales (Google Maps)<br>
          <span style="color:#dc2626">Marcadores rojos</span> → Zonas oficiales del SRI<br>
          <span style="color:#f97316">Marcadores naranjas grandes</span> → Más de 150 establecimientos registrados
        </div>
        <div id="map"></div>

        <!-- COMPARATIVA FINAL CON TOTAL OFICIAL Y EXPANSIÓN -->
        <div class="top-sri-panel">
          <h2>Comparativa Google Maps vs SRI (Datos Oficiales 2025)</h2>
          <div class="kpi-grid" style="margin-bottom:2rem;">
            <div class="kpi-card success"><h3>Librerías en Google Maps</h3><p id="googleCount">0</p></div>
            <div class="kpi-card danger"><h3>Zonas SRI registradas</h3><p id="sriCount">0</p></div>
            <div class="kpi-card danger"><h3>Total establecimientos SRI</h3><p id="totalSRI">0</p></div>
            <div class="kpi-card" id="coberturaCard"><h3>Cobertura real (Google vs SRI)</h3><p id="coberturaPorcentaje">0%</p></div>
            <div class="kpi-card warning" id="provinciaSriCard" style="display:none;"></div>
          </div>

          <div class="top-sri-inner">
            <strong>Top 10 Zonas con más establecimientos registrados (Datos oficiales SRI)</strong>
            <table>
              <thead><tr><th>#</th><th>Zona / Parroquia</th><th>Establecimientos</th></tr></thead>
              <tbody id="topSRI"></tbody>
            </table>
            <div class="metodologia-footer-row">
              <div class="ver-mas" id="verMasSRI" style="margin-top:1rem;">Ver más zonas</div>
              <button class="csv-button" id="csvTopSRI">Descargar Top SRI CSV</button>
            </div>
          </div>
        </div>
      </div>
      `;

      // (Código de tops y tablas normales igual que antes...)

      // Inyección en Metodología: ejemplo dinámico sincronizado
      try {
        const cont = document.getElementById("met-ej-dinamico-body");
        const concl = document.getElementById("met-conclusion-body");
        if (cont && resumenProvincias.length > 0) {
          const filtroProvActual = provinciaKpi && provinciaKpi !== "TODAS" ? provinciaKpi : null;
          if (filtroProvActual) {
            const sp = resumenProvincias.find(r => r.provincia === filtroProvActual);
            if (sp) {
              const minProm = Math.min(...resumenProvincias.map(r => r.promedio));
              const maxProm = Math.max(...resumenProvincias.map(r => r.promedio));
              const maxOfertas = Math.max(...resumenProvincias.map(r => r.ofertas));
              const maxLibreriasProv = Math.max(...resumenProvincias.map(r => r.librerias));
              const sPrecio = maxProm > minProm ? (maxProm - sp.promedio) / (maxProm - minProm) : 1;
              const sOfertas = maxOfertas ? sp.ofertas / maxOfertas : 0;
              const sLibrerias = maxLibreriasProv ? sp.librerias / maxLibreriasProv : 0;
              const hProv = heuristicaPorProvincia[filtroProvActual] != null ? heuristicaPorProvincia[filtroProvActual] : null;
              cont.innerHTML = `
                <div class="kpi-grid formula-block">
                  <div class="kpi-card"><h3>Provincia</h3><p>${etiquetaProvincia(filtroProvActual)}</p></div>
                  <div class="kpi-card"><h3><span class="f-overline">P</span></h3><p>$${sp.promedio.toFixed(2)}</p></div>
                  <div class="kpi-card"><h3>min<sub>P</sub> <span class="f-overline">P</span> / max<sub>P</sub> <span class="f-overline">P</span></h3><p>$${minProm.toFixed(2)} / $${maxProm.toFixed(2)}</p></div>
                  <div class="kpi-card"><h3>O / max O</h3><p>${sp.ofertas} / ${maxOfertas}</p></div>
                  <div class="kpi-card"><h3>L / max L</h3><p>${sp.librerias} / ${maxLibreriasProv}</p></div>
                  <div class="kpi-card"><h3>S<sub>precio</sub></h3><p>${sPrecio.toFixed(3)}</p></div>
                  <div class="kpi-card"><h3>S<sub>ofertas</sub></h3><p>${sOfertas.toFixed(3)}</p></div>
                  <div class="kpi-card"><h3>S<sub>librerías</sub></h3><p>${sLibrerias.toFixed(3)}</p></div>
                  <div class="kpi-card"><h3>H</h3><p>${hProv != null ? hProv.toFixed(1) : "–"}</p></div>
                </div>
                <div class="formula-block" style="background:#0f172a;color:#e5e7eb;padding:1rem;border-radius:12px;font-family:ui-monospace,Menlo,Consolas,monospace;margin-top:1rem;line-height:1.7">
                  <div><strong>Fórmulas con sustitución (provincia actual)</strong></div>
                  <div>S<sub>precio</sub> = (max<sub>P</sub> <span class="f-overline">P</span> − <span class="f-overline">P</span>) / (max<sub>P</sub> <span class="f-overline">P</span> − min<sub>P</sub> <span class="f-overline">P</span>) = (${maxProm.toFixed(2)} − ${sp.promedio.toFixed(2)}) / (${maxProm.toFixed(2)} − ${minProm.toFixed(2)}) = ${sPrecio.toFixed(3)}</div>
                  <div>S<sub>ofertas</sub> = O / max O = ${sp.ofertas} / ${maxOfertas} = ${sOfertas.toFixed(3)}</div>
                  <div>S<sub>librerías</sub> = L / max L = ${sp.librerias} / ${maxLibreriasProv} = ${sLibrerias.toFixed(3)}</div>
                  <div style="margin-top:.5rem">H = 100 · (0,4·S<sub>precio</sub> + 0,4·S<sub>ofertas</sub> + 0,2·S<sub>librerías</sub>)</div>
                  <div>= 100 · (0,4·${sPrecio.toFixed(3)} + 0,4·${sOfertas.toFixed(3)} + 0,2·${sLibrerias.toFixed(3)})</div>
                  <div>= <strong>${hProv != null ? hProv.toFixed(1) : "–"} puntos</strong> (escala 0–100)</div>
                </div>
                <small style="color:#9ca3af;display:block;margin-top:.5rem">Estos valores se derivan automáticamente de los JSON cargados y cambian al seleccionar otra provincia.</small>
              `;
              if (concl) {
                const htxt = hProv != null ? hProv.toFixed(1) : "–";
                concl.innerHTML = `
                  <p><strong>Lectura del índice:</strong> H<sub>${etiquetaProvincia(filtroProvActual)}</sub> = ${htxt}/100, en una escala donde 0 indica el peor escenario (precios altos, pocas ofertas y pocas librerías activas) y 100 el mejor (precios competitivos, alta frecuencia de ofertas y amplia presencia de librerías).</p>
                  <ul>
                    <li>No tiene unidades físicas: es un puntaje compuesto, adimensional (precio normalizado, frecuencia de ofertas, número de librerías).</li>
                    <li>Cerca de 0 → mercado formal muy débil: caro, poco denso y poco diverso.</li>
                    <li>Cerca de 100 → mercado formal muy fuerte: precios competitivos, muchas ofertas y muchas librerías.</li>
                  </ul>
                `;
              }
            }
          } else {
            cont.innerHTML = `
              <div class="kpi-grid formula-block">
                <div class="kpi-card"><h3>Vista</h3><p>Ecuador completo</p></div>
                <div class="kpi-card"><h3>H<sub>ECU</sub></h3><p>${heuristicaNacional != null ? heuristicaNacional.toFixed(1) : "–"}</p></div>
              </div>
              <div class="formula-block" style="background:#0f172a;color:#e5e7eb;padding:1rem;border-radius:12px;font-family:ui-monospace,Menlo,Consolas,monospace;margin-top:1rem;line-height:1.7">
                <div><strong>Fórmula nacional</strong></div>
                <div>H<sub>ECU</sub> = Σ (w<sub>p</sub> · H<sub>p</sub>),&nbsp;&nbsp;w<sub>p</sub> = O<sub>p</sub> / Σ<sub>q ∈ P</sub> O<sub>q</sub></div>
                <div>Interpretación: pondera los H<sub>p</sub> por el volumen de ofertas de cada provincia.</div>
                <div style="margin-top:.5rem">Valor actual: <strong>${heuristicaNacional != null ? heuristicaNacional.toFixed(1) : "–"} puntos</strong> (escala 0–100)</div>
              </div>
              <small style="color:#9ca3af;display:block;margin-top:.5rem">H<sub>ECU</sub> se calcula ponderando H<sub>p</sub> por el volumen de ofertas en cada provincia.</small>
            `;
            if (concl) {
              const htxt = heuristicaNacional != null ? heuristicaNacional.toFixed(1) : "–";
              concl.innerHTML = `
                <p><strong>Conclusión nacional:</strong> En el corte analizado, el índice heurístico nacional del mercado formal del libro en Ecuador es de <strong>H<sub>ECU</sub> = ${htxt} puntos (escala 0–100)</strong>, lo que sugiere un desempeño intermedio si el valor está alrededor de 50: existen núcleos con alta oferta y presencia de librerías, pero también provincias con baja actividad y posible rezago en acceso al libro.</p>
                <ul>
                  <li>No tiene unidades físicas: es un puntaje compuesto, adimensional (precio normalizado, frecuencia de ofertas, número de librerías).</li>
                  <li>Cerca de 0 → mercado formal muy débil: caro, poco denso y poco diverso.</li>
                  <li>Cerca de 100 → mercado formal muy fuerte: precios competitivos, muchas ofertas y muchas librerías.</li>
                </ul>
              `;
            }
          }
        }
      } catch (e) { }

      Object.entries(grupo).sort((a, b) => b[1].length - a[1].length).slice(0, 15).forEach(([k, v]) => {
        const libro = v[0], min = Math.min(...v.map(x => x.precio));
        document.getElementById("topGrid").innerHTML += `
        <div class="book-card" onclick="abrirModal('${k.replace(/'/g, "\\'")}')">
          <img src="${libro.imagen || defaultImg}" onerror="this.src='${defaultImg}'" loading="lazy">
          <div class="book-info"><h4>${libro.titulo}</h4><div class="price">$${min.toFixed(2)}</div><div class="disponible">En ${v.length} librerías</div></div>
        </div>`;
      });

      rankingBaratas.slice(0, 10).forEach((l, i) => document.getElementById("baratasBody").innerHTML += `<tr><td>${i + 1}</td><td>${l.nombre}</td><td>$${l.promedio}</td><td>${l.libros}</td></tr>`);
      rankingCaras.slice(0, 10).forEach((l, i) => document.getElementById("carasBody").innerHTML += `<tr><td>${i + 1}</td><td>${l.nombre}</td><td>$${l.promedio}</td><td>${l.libros}</td></tr>`);
      precios.slice().sort((a, b) => a.precio - b.precio).slice(0, 15).forEach(l => {
        const t = l.titulo.length > 60 ? l.titulo.substr(0, 60) + '...' : l.titulo;
        document.getElementById("cheapestBody").innerHTML += `<tr><td title="${l.titulo}">${t}</td><td style="color:green;font-weight:bold">$${l.precio.toFixed(2)}</td><td>${l.libreria}</td></tr>`;
      });


      // ==================== VER MÁS DE 10 EN 10 (INTELIGENTE) ====================

      // Librerías Más Baratas
      let offsetBaratas = 10;
      document.getElementById("verMasBaratas").onclick = () => {
        const siguientes = rankingBaratas.slice(offsetBaratas, offsetBaratas + 10);
        siguientes.forEach((l, i) => {
          document.getElementById("baratasBody").innerHTML +=
            `<tr><td>${offsetBaratas + i + 1}</td><td>${l.nombre}</td><td>$${l.promedio}</td><td>${l.libros}</td></tr>`;
        });
        offsetBaratas += 10;

        // Si ya no hay más, elimina el botón
        if (offsetBaratas >= rankingBaratas.length) {
          document.getElementById("verMasBaratas").remove();
        }
      };

      // Librerías Más Caras
      let offsetCaras = 10;
      document.getElementById("verMasCaras").onclick = () => {
        const siguientes = rankingCaras.slice(offsetCaras, offsetCaras + 10);
        siguientes.forEach((l, i) => {
          document.getElementById("carasBody").innerHTML +=
            `<tr><td>${offsetCaras + i + 1}</td><td>${l.nombre}</td><td>$${l.promedio}</td><td>${l.libros}</td></tr>`;
        });
        offsetCaras += 10;

        if (offsetCaras >= rankingCaras.length) {
          document.getElementById("verMasCaras").remove();
        }
      };

      // Libros Más Baratos (ordenados por precio)
      let offsetCheapest = 15;
      document.getElementById("verMasCheapest").onclick = () => {
        const listaOrdenada = [...precios].sort((a, b) => a.precio - b.precio);
        const siguientes = listaOrdenada.slice(offsetCheapest, offsetCheapest + 10);

        siguientes.forEach((l, i) => {
          const tituloCorto = l.titulo.length > 60 ? l.titulo.substr(0, 60) + '...' : l.titulo;
          document.getElementById("cheapestBody").innerHTML +=
            `<tr>
        <td title="${l.titulo}">${tituloCorto}</td>
        <td style="color:green;font-weight:bold">$${l.precio.toFixed(2)}</td>
        <td>${l.libreria}</td>
      </tr>`;
        });

        offsetCheapest += 10;

        // Elimina el botón si ya no quedan más libros
        if (offsetCheapest >= listaOrdenada.length) {
          document.getElementById("verMasCheapest").remove();
        }
      };
      inicializarMapa();

      const btnCSVBaratas = document.getElementById("csvBaratas");
      if (btnCSVBaratas) {
        btnCSVBaratas.onclick = () => {
          const filas = rankingBaratas.map((l, i) => ({
            posicion: i + 1,
            libreria: l.nombre,
            precio_promedio: l.promedio,
            total_libros: l.libros
          }));
          descargarCSVGenerico(filas, "librerias_mas_baratas.csv");
        };
      }

      const selectKpi = document.getElementById("provinciaKpiSelect");
      if (selectKpi) {
        selectKpi.value = provinciaKpi || "TODAS";
        selectKpi.onchange = () => {
          provinciaKpi = selectKpi.value;
          aplicarFiltroKpi();
        };
      }
      const selectKpiMet = document.getElementById("provinciaKpiSelectMet");
      if (selectKpiMet) {
        selectKpiMet.innerHTML = opcionesProvinciaKpi;
        const valores = Array.from(selectKpiMet.options).map(o => o.value);
        const destino = valores.includes(provinciaKpi) ? provinciaKpi : "TODAS";
        selectKpiMet.value = destino;
        selectKpiMet.onchange = () => {
          provinciaKpi = selectKpiMet.value;
          aplicarFiltroKpi();
        };
        if (!selectKpiMet.value) {
          selectKpiMet.selectedIndex = 0;
        }
      }
    }

    function configurarProvinciaSelect() {
      const select = document.getElementById("provinciaSelect");
      if (!select) return;
      const actual = provinciaActiva || "TODAS";
      let opciones = `<option value="TODAS">Ecuador completo</option>`;
      provincias.forEach(p => {
        const codigo = normalizarProvincia(p);
        opciones += `<option value="${codigo}">${etiquetaProvincia(codigo)}</option>`;
      });
      select.innerHTML = opciones;
      select.value = provincias.includes(actual) || actual === "TODAS" ? actual : "TODAS";
      select.onchange = () => {
        provinciaActiva = select.value;
        renderMapa();
      };
    }

    function inicializarMapa() {
      if (mapa) {
        mapa.remove();
        mapa = null;
      }
      mapa = L.map('map').setView([-1.8312, -78.1834], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(mapa);
      capaGoogle = L.markerClusterGroup({ maxClusterRadius: 50, spiderfyOnMaxZoom: true }).addTo(mapa);
      capaSRI = L.layerGroup().addTo(mapa);
      configurarProvinciaSelect();
      // activar filtro por tipo (checkboxes)
      const mapFilters = document.getElementById("mapFilters");
      if (mapFilters) {
        mapFilters.querySelectorAll("input[type=checkbox]").forEach(cb => {
          cb.onchange = () => renderMapa();
        });
      }
      if (datosSRI && datosSRI.length > 0) {
        renderMapa();
      } else {
        fetch((typeof DATA_PATH !== 'undefined' ? DATA_PATH : 'data/') + 'sri_pichincha_pastaza_coordenadas.json' + (typeof BUST !== 'undefined' ? BUST : ''))
          .then(r => r.ok ? r.json() : Promise.reject())
          .then(sri => {
            datosSRI = sri;
            renderMapa();
          })
          .catch(() => {
            const el = document.getElementById("sriCount");
            if (el) el.textContent = "No disponible";
            renderMapa();
          });
      }
    }

    function renderMapa() {
      if (!mapa || !capaGoogle || !capaSRI) return;
      capaGoogle.clearLayers();
      capaSRI.clearLayers();

      const iconGoogle = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] });
      const iconSRI = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] });
      const iconSRIGrande = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', iconSize: [38, 62], iconAnchor: [19, 62], popupAnchor: [1, -50] });
      const filtroProvincia = provinciaActiva && provinciaActiva !== "TODAS" ? provinciaActiva : null;

      const tiposActivos = filtrosMapaActivos();

const ubicacionesFiltradas = ubicaciones.filter(lib => {
  if (!lib.lat || !lib.lng) return false;

  // 1) filtro provincia (tu lógica)
  const codigo = normalizarProvincia(lib.provincia || "");
  if (filtroProvincia && codigo !== filtroProvincia) return false;

  // 2) filtro tipo (nuevo)
  const cat = categoriaDesdeKeyword(lib.keyword_found);
  if (!tiposActivos.includes(cat)) return false;

  return true;
});

const googleCount = ubicacionesFiltradas.length;

      const sriFiltrado = (datosSRI || []).filter(z => {
        if (!z.lat || !z.lng) return false;
        if (!filtroProvincia) return true;
        const codigo = normalizarProvincia(z.DESCRIPCION_PROVINCIA_EST);
        return codigo === filtroProvincia;
      });
      const totalEstablecimientosSRI = sriFiltrado.reduce((a, z) => a + z.TOTAL_SUM_ESTABLECIMIENTOS, 0);
      const coberturaReal = totalEstablecimientosSRI > 0 ? Math.round((googleCount / totalEstablecimientosSRI) * 100) : 0;
      const totalNacionalSRI = (datosSRI || []).reduce((a, z) => a + (Number(z.TOTAL_SUM_ESTABLECIMIENTOS) || 0), 0);

      // Actualizar KPIs y tabla de inmediato (sin esperar a los marcadores)
      const googleCountEl = document.getElementById("googleCount");
      const sriCountEl = document.getElementById("sriCount");
      const totalSRIEl = document.getElementById("totalSRI");
      const coberturaCardEl = document.getElementById("coberturaCard");
      const provinciaSriCardEl = document.getElementById("provinciaSriCard");
      if (googleCountEl) googleCountEl.textContent = googleCount.toLocaleString();
      if (sriCountEl) sriCountEl.textContent = sriFiltrado.length + " zonas";
      if (totalSRIEl) totalSRIEl.textContent = totalNacionalSRI.toLocaleString();
      if (coberturaCardEl) coberturaCardEl.innerHTML = `
        <h3>Cobertura real (Google vs SRI)</h3>
        <p style="font-size:2.4rem;color:${coberturaReal < 40 ? '#ef4444' : '#f59e0b'}">${coberturaReal}%</p>
        <small style="color:#64748b;font-size:0.95rem">
          ${googleCount} ubicaciones exactas<br>
          de <strong>${totalEstablecimientosSRI.toLocaleString()}</strong> establecimientos oficiales
        </small>
      `;
      if (provinciaSriCardEl) {
        if (filtroProvincia) {
          const etiquetaProv = etiquetaProvincia(filtroProvincia);
          const participacionNacional = totalNacionalSRI > 0 ? (totalEstablecimientosSRI / totalNacionalSRI) * 100 : 0;
          const promedioZona = sriFiltrado.length > 0 ? Math.round(totalEstablecimientosSRI / sriFiltrado.length) : 0;
          const zonaMayor = sriFiltrado.reduce((best, z) => {
            const total = Number(z.TOTAL_SUM_ESTABLECIMIENTOS) || 0;
            const nombre = (z.DIRECCION || "").split(',')[0].replace('Quito', '').trim() || "Zona";
            if (!best || total > best.total) return { nombre, total };
            return best;
          }, null);
          provinciaSriCardEl.style.display = "block";
          provinciaSriCardEl.innerHTML = `
            <h3>SRI en ${etiquetaProv}</h3>
            <p>${totalEstablecimientosSRI.toLocaleString()}</p>
            <small style="display:block;color:#64748b;font-size:0.95rem;line-height:1.45">
              ${sriFiltrado.length.toLocaleString()} zonas registradas<br>
              Promedio por zona: <strong>${promedioZona.toLocaleString()}</strong><br>
              Participación nacional: <strong>${participacionNacional.toFixed(1)}%</strong>
              ${zonaMayor ? `<br>Zona líder: <strong>${zonaMayor.nombre}</strong> (${zonaMayor.total.toLocaleString()})` : ""}
            </small>
          `;
        } else {
          provinciaSriCardEl.style.display = "none";
          provinciaSriCardEl.innerHTML = "";
        }
      }

      const topOrdenado = [...(datosSRI || [])].filter(z => {
        if (!filtroProvincia) return true;
        const codigo = normalizarProvincia(z.DESCRIPCION_PROVINCIA_EST);
        return codigo === filtroProvincia;
      }).sort((a, b) => b.TOTAL_SUM_ESTABLECIMIENTOS - a.TOTAL_SUM_ESTABLECIMIENTOS);
      const mostrarTop = (hasta = 10) => {
        const topSRIEl = document.getElementById("topSRI");
        if (topSRIEl) topSRIEl.innerHTML = topOrdenado.slice(0, hasta).map((z, i) => {
          const nombre = z.DIRECCION.split(',')[0].replace('Quito', '').trim() || 'Zona';
          return `<tr><td>${i + 1}</td><td>${nombre}</td><td><strong>${z.TOTAL_SUM_ESTABLECIMIENTOS}</strong></td></tr>`;
        }).join("");
      };
      mostrarTop(10);
      const verMas = document.getElementById("verMasSRI");
      if (verMas) {
        verMas.onclick = () => { mostrarTop(1000); verMas.remove(); };
      }
      const btnSRI = document.getElementById("csvTopSRI");
      if (btnSRI) {
        btnSRI.onclick = () => {
          const filas = topOrdenado.map((z, i) => ({
            posicion: i + 1,
            zona: z.DIRECCION,
            provincia: z.DESCRIPCION_PROVINCIA_EST,
            establecimientos: z.TOTAL_SUM_ESTABLECIMIENTOS
          }));
          descargarCSVGenerico(filas, "top_sri.csv");
        };
      }

      const puntos = [];

      // Marcadores SRI (pocos, se añaden de una vez)
      sriFiltrado.forEach(z => {
        const esGrande = z.TOTAL_SUM_ESTABLECIMIENTOS > 150;
        const zonaNombre = z.DIRECCION.split(',')[0].replace('Quito', '').trim() || 'Zona';
        const marcador = L.marker([z.lat, z.lng], { icon: esGrande ? iconSRIGrande : iconSRI }).addTo(capaSRI);
        marcador.bindPopup(`<div style="font-size:14px"><b style="color:#dc2626">Zona oficial SRI</b><br><b>${zonaNombre}</b><br><hr style="margin:8px 0;border-top:1px solid #eee"><small><b>Establecimientos:</b> ${z.TOTAL_SUM_ESTABLECIMIENTOS}<br><b>Provincia:</b> ${z.DESCRIPCION_PROVINCIA_EST}</small></div>`);
        puntos.push([z.lat, z.lng]);
      });

      // Marcadores de librerías por lotes (evita bloquear la interfaz)
      const BATCH_SIZE = 80;
      let index = 0;
      function addMarkerBatch() {
        const end = Math.min(index + BATCH_SIZE, ubicacionesFiltradas.length);
        for (let i = index; i < end; i++) {
          const lib = ubicacionesFiltradas[i];
          const marcador = L.marker([lib.lat, lib.lng], { icon: iconGoogle });
          const cat = categoriaDesdeKeyword(lib.keyword_found);
const link = lib.website ? `<br><a href="${lib.website}" target="_blank" rel="noopener">Sitio / enlace</a>` : "";
marcador.bindPopup(`
  <b style="color:#1e40af">Establecimiento (Google)</b><br>
  <b>${lib.nombre || 'Sin nombre'}</b><br>
  ${lib.direccion || ''}<br>
  <small><b>Tipo:</b> ${cat} · <b>Provincia:</b> ${lib.provincia || "N/D"}</small>
  ${link}
`);
          capaGoogle.addLayer(marcador);
          puntos.push([lib.lat, lib.lng]);
        }
        index = end;
        if (index < ubicacionesFiltradas.length) {
          requestAnimationFrame(addMarkerBatch);
        } else if (puntos.length > 0) {
          mapa.fitBounds(puntos, { padding: [50, 50] });
        }
      }
      if (ubicacionesFiltradas.length > 0) {
        requestAnimationFrame(addMarkerBatch);
      } else if (puntos.length > 0) {
        mapa.fitBounds(puntos, { padding: [50, 50] });
      }
    }

    // CATÁLOGO, MODAL y funciones openTab igual que antes...
    function renderCatalogo() {
      const opcionesProvincia = provincias.length
        ? provincias.map(p => `<option value="${p}">${etiquetaProvincia(p)}</option>`).join("")
        : "";
      document.getElementById("catalogo").innerHTML = `<div class="section"><h2>Catálogo Completo (${Object.keys(grupo).length} libros únicos)</h2><div class="catalogo-filtros"><input type="text" class="table-search" id="searchCat" placeholder="Buscar libro, autor, editorial..." onkeyup="filtrarCat()"><select id="provinciaCat" class="provincia-select" onchange="filtrarCat()"><option value="TODAS">Todas las provincias</option>${opcionesProvincia}</select></div><div class="books-grid" id="catGrid"></div></div>`;
      mostrarTodos();
    }
    function mostrarTodos() {
      const g = document.getElementById("catGrid"); g.innerHTML = "";
      Object.entries(grupo).forEach(([k, v]) => {
        const libro = v[0], min = Math.min(...v.map(x => x.precio));
        g.innerHTML += `<div class="book-card" onclick="abrirModal('${k.replace(/'/g, "\\'")}')">
          <img src="${libro.imagen || defaultImg}" onerror="this.src='${defaultImg}'" loading="lazy">
          <div class="book-info"><h4>${libro.titulo}</h4><div class="price">$${min.toFixed(2)}</div><div class="disponible">En ${v.length} librerías</div></div>
        </div>`;
      });
    }
    function filtrarCat() {
      const t = document.getElementById("searchCat").value.toLowerCase();
      const g = document.getElementById("catGrid"); g.innerHTML = "";
      const selectProvincia = document.getElementById("provinciaCat");
      const filtroProvincia = selectProvincia ? selectProvincia.value : "TODAS";
      Object.entries(grupo)
        .filter(([k, _]) => k.toLowerCase().includes(t))
        .filter(([_, v]) => {
          if (!filtroProvincia || filtroProvincia === "TODAS") return true;
          const setProv = new Set(v.map(x => normalizarProvincia(x.provincia || "")));
          return setProv.has(filtroProvincia);
        })
        .forEach(([k, v]) => {
          const libro = v[0], min = Math.min(...v.map(x => x.precio));
          g.innerHTML += `<div class="book-card" onclick="abrirModal('${k.replace(/'/g, "\\'")}')">
          <img src="${libro.imagen || defaultImg}" onerror="this.src='${defaultImg}'" loading="lazy">
          <div class="book-info"><h4>${libro.titulo}</h4><div class="price">$${min.toFixed(2)}</div><div class="disponible">En ${v.length} librerías</div></div>
        </div>`;
        });
    }

    let modalData = [];
    function abrirModal(clave) {
      modalData = grupo[clave];
      document.getElementById("modalTitulo").textContent = modalData[0].titulo;
      renderModal();
      document.getElementById("modal").style.display = "block";
    }
    function renderModal() {
      let d = [...modalData];
      const o = document.getElementById("modalOrder").value;
      if (o === "precio-asc") d.sort((a, b) => a.precio - b.precio);
      if (o === "precio-desc") d.sort((a, b) => b.precio - a.precio);
      const f = document.getElementById("modalSearch").value.toLowerCase();
      if (f) d = d.filter(l => l.libreria.toLowerCase().includes(f));
      document.getElementById("modalBody").innerHTML = d.map(l => `<tr><td>${l.libreria}</td><td style="color:#10b981;font-weight:700">$${l.precio.toFixed(2)}</td><td>Disponible</td></tr>`).join("");
    }
    function filtrarModal() { renderModal(); }
    function ordenarModal() { renderModal(); }

    function openTab(id) {
      document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      document.querySelector(`[onclick="openTab('${id}')"]`).classList.add("active");
    }

    function descargarCSVGenerico(filas, nombre) {
      if (!filas || !filas.length) return;
      const encabezados = Object.keys(filas[0]);
      const lineas = [];
      lineas.push(encabezados.join(";"));
      filas.forEach(f => {
        lineas.push(encabezados.map(c => {
          const valor = f[c] == null ? "" : String(f[c]).replace(/"/g, '""');
          return `"${valor}"`;
        }).join(";"));
      });
      const blob = new Blob([lineas.join("\n")], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = nombre;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function togglePresentacion() {
      document.body.classList.toggle("presentation");
    }

    cargarDatos();
  </script>
</body>

</html>
