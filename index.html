<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Libros Ecuador 2025</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="index.css" />
</head>

<body>

  <header>
    <div class="header-inner">
      <div class="header-text">
        <h1>Observatorio del Libro UCE</h1>
        <p class="subtitle">Universidad Central del Ecuador · Libros, precios y territorio</p>
        <div class="header-meta">
          Proyecto académico para analizar la red de librerías y el acceso al libro en Ecuador.
        </div>
      </div>
      <div class="header-badges">
        <span class="pill pill-accent">Trabajo de titulación UCE</span>
        <span class="pill">Cobertura nacional en construcción</span>
        <button class="presentation-toggle" onclick="togglePresentacion()">Modo presentación</button>
      </div>
    </div>
  </header>

    <div class="tabs">
    <div class="tab active" onclick="openTab('dashboard')">Panorama nacional</div>
    <div class="tab" onclick="openTab('catalogo')">Catálogo de libros</div>
    <div class="tab" onclick="openTab('metodologia')">Metodología UCE</div>
  </div>

  <div class="container">
    <div id="dashboard" class="tab-content active">
      <div class="loading">Cargando datos…</div>
    </div>
    <div id="catalogo" class="tab-content">
      <div class="loading">Preparando catálogo…</div>
    </div>
    <div id="metodologia" class="tab-content">
      <div class="section metodologia-section">
        <h2>Metodología del Observatorio UCE</h2>
        <p class="metodologia-intro">
          Este observatorio combina datos oficiales del Servicio de Rentas Internas (SRI) con librerías geolocalizadas en Google Maps para evaluar la disponibilidad real de libros en Ecuador.
        </p>
        <div class="metodologia-grid">
          <div class="metodologia-card">
            <h3>Fuentes de datos</h3>
            <ul>
              <li>Registros oficiales del SRI por provincia y zona.</li>
              <li>Librerías y papelerías detectadas en Google Maps.</li>
              <li>Precios reales de catálogos comerciales de librerías.</li>
            </ul>
          </div>
          <div class="metodologia-card">
            <h3>Fecha de corte</h3>
            <p>
              Los datos utilizados corresponden al año 2025. Nuevos JSON por provincia (por ejemplo precios_pichincha.json, ubicaciones_pichincha.json o precios_azuay.json) pueden incorporarse para actualizar el análisis sin modificar el código.
            </p>
          </div>
          <div class="metodologia-card">
            <h3>Limitaciones</h3>
            <ul>
              <li>No todas las librerías del país cuentan con presencia digital.</li>
              <li>Los precios pueden cambiar con el tiempo respecto a los catálogos capturados.</li>
              <li>La cobertura por provincia depende de la calidad de los JSON aportados por el equipo.</li>
            </ul>
          </div>
        </div>
        <p class="metodologia-nota">
          La plataforma está pensada como herramienta de apoyo para el análisis académico de la Universidad Central del Ecuador, no como listado comercial definitivo.
        </p>
      </div>
    </div>
  </div>

  <div class="back-top" id="backTop" onclick="window.scrollTo({top:0,behavior:'smooth'})">
    <i class="fas fa-arrow-up"></i>
  </div>

  <div id="modal" class="modal" onclick="if(event.target===this)this.style.display='none'">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitulo">Libro</h2>
        <span class="close" onclick="document.getElementById('modal').style.display='none'">×</span>
      </div>
      <div class="modal-body">
        <div class="modal-controls">
          <input type="text" id="modalSearch" placeholder="Filtrar librería..." onkeyup="filtrarModal()">
          <select id="modalOrder" onchange="ordenarModal()">
            <option value="precio-asc">Precio: menor → mayor</option>
            <option value="precio-desc">Precio: mayor → menor</option>
          </select>
        </div>
        <table>
          <thead>
            <tr>
              <th>Librería</th>
              <th>Precio</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody id="modalBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const defaultImg = "https://placehold.co/400x600/cccccc/666666?text=Sin+Portada";
    const CACHE_KEY = "librosEcuador_v39";
    const EXTRA_PRECIOS_FILES = [];
    const EXTRA_UBICACIONES_FILES = [
      "librerias_ecuador_cañar_db.json",
      "librerias_ecuador_tungurahua_db.json",
      "librerias_ecuador_napo_db.json",
      "librerias_ecuador_bolívar_db.json",
      "librerias_ecuador_orellana_db.json",
      "librerias_ecuador_chimborazo_db.json",
      "librerias_ecuador_manabí_db.json",
      "librerias_ecuador_cotopaxi_db.json",
      "librerias_ecuador_imbabura_db.json",
      "librerias_ecuador_loja_db.json",
      "galapagos_normalizado.json",
      "librerias_2_zamora_chinchipe.json",
      "librerias_2_sucumbios.json",
      "librerias_2_santo_domingo_tsachilas.json",
      "librerias_2_morona_santiago.json",
      "LOS_RIOS.json",
      "ESMERALDAS_CARCHI.json",
      "AZUAY_GUAYAS.json"
    ];
    const EXTRA_SRI_FILES = [];
    let preciosBase = [], grupoBase = {}, precios = [], grupo = [], ubicaciones = [], provincias = [], provinciaActiva = "TODAS", provinciaKpi = "TODAS", datosSRI = [], mapa, capaGoogle, capaSRI;

    function normalizarProvincia(nombre) {
      return (nombre || "").toString().trim().toUpperCase();
    }

    function etiquetaProvincia(codigo) {
      const c = (codigo || "").toString().trim().toUpperCase();
      if (!c) return "";
      return c.charAt(0) + c.slice(1).toLowerCase();
    }

    async function cargarDatos() {
      const cached = localStorage.getItem(CACHE_KEY);
      if (cached) {
        try {
          const data = JSON.parse(cached);
          procesarDatos(data.destacados || [], data.preciosRaw || [], data.ubicaciones || []);
          return;
        } catch (e) { localStorage.removeItem(CACHE_KEY); }
      }

      document.getElementById('dashboard').innerHTML = `<div class="loading">Cargando datos…<br><small>Libros, precios y mapa (3-8 segundos la primera vez)</small></div>`;

      let destacados = [], preciosRaw = [], ubicaciones = [];

      try { const r = await fetch('libros_imagenes.json'); if (r.ok) destacados = await r.json(); } catch (e) { }
      try { const r = await fetch('librerias_procesadas.json'); if (!r.ok) throw 1; preciosRaw = await r.json(); }
      catch (e) { document.getElementById('dashboard').innerHTML = `<div style="color:red;text-align:center;padding:5rem;font-size:2rem;">No se pudieron cargar los datos de librerías.<br><small style="font-size:1.2rem;color:#4b5563">Asegúrate de abrir el proyecto con un servidor web (por ejemplo <code>python -m http.server</code>) y que el archivo <strong>librerias_procesadas.json</strong> esté en la misma carpeta que <strong>index.html</strong>.</small><br><button onclick="location.reload()" style="margin-top:2rem;padding:1rem 2rem;background:#003366;color:white;border:none;border-radius:12px;cursor:pointer">Reintentar</button></div>`; return; }
      try { const r = await fetch('librerias_ecuador_pichincha_pastaza_intermedia.json'); if (r.ok) ubicaciones = await r.json(); } catch (e) { }

      for (const archivo of EXTRA_PRECIOS_FILES) {
        try {
          const r = await fetch(archivo);
          if (r.ok) {
            const extra = await r.json();
            if (Array.isArray(extra)) preciosRaw = preciosRaw.concat(extra);
          }
        } catch (e) { }
      }

      for (const archivo of EXTRA_UBICACIONES_FILES) {
        try {
          const r = await fetch(archivo);
          if (r.ok) {
            const extra = await r.json();
            if (Array.isArray(extra)) ubicaciones = ubicaciones.concat(extra);
          }
        } catch (e) { }
      }

      localStorage.setItem(CACHE_KEY, JSON.stringify({ destacados, preciosRaw, ubicaciones }));
      procesarDatos(destacados, preciosRaw, ubicaciones);
    }

    function procesarDatos(destacados, preciosRaw, ubicacionesGuardadas) {
      ubicaciones = ubicacionesGuardadas;
      preciosBase = preciosRaw.filter(l => {
        const p = Number(l.precio) || 0, t = (l.titulo || "").trim(), lib = (l.libreria || "").toLowerCase();
        return p >= 2 && p <= 120 && t && !/^libro(\s*\d*)?$/i.test(t) && !lib.includes("coral") && !lib.includes("hipermercados") && !lib.includes("tama shop") && !lib.includes("tía conocoto");
      });

      preciosBase.forEach(l => {
        const m = destacados.find(d => d.titulo.toLowerCase().includes(l.titulo.toLowerCase()));
        if (m && m.imagen) l.imagen = m.imagen;
      });

      grupoBase = {};
      const visto = new Set();
      preciosBase.forEach(l => {
        const claveTitulo = l.titulo.trim().toUpperCase();
        const clave = `${claveTitulo}|||${l.libreria}`;
        if (!visto.has(clave)) {
          visto.add(clave);
          if (!grupoBase[claveTitulo]) grupoBase[claveTitulo] = [];
          grupoBase[claveTitulo].push(l);
        }
      });

      const setProvincias = new Set();
      preciosBase.forEach(l => { if (l.provincia) setProvincias.add(normalizarProvincia(l.provincia)); });
      ubicaciones.forEach(l => { if (l.provincia) setProvincias.add(normalizarProvincia(l.provincia)); });
      provincias = Array.from(setProvincias).sort();

      aplicarFiltroKpi();
      window.addEventListener('scroll', () => document.getElementById('backTop').classList.toggle('show', window.scrollY > 500));
    }

    function aplicarFiltroKpi() {
      if (!preciosBase.length) return;
      const filtro = provinciaKpi && provinciaKpi !== "TODAS" ? provinciaKpi : null;

      if (filtro) {
        precios = preciosBase.filter(l => normalizarProvincia(l.provincia || "") === filtro);
      } else {
        precios = [...preciosBase];
      }

      grupo = {};
      const visto = new Set();
      precios.forEach(l => {
        const claveTitulo = l.titulo.trim().toUpperCase();
        const clave = `${claveTitulo}|||${l.libreria}`;
        if (!visto.has(clave)) {
          visto.add(clave);
          if (!grupo[claveTitulo]) grupo[claveTitulo] = [];
          grupo[claveTitulo].push(l);
        }
      });

      renderDashboard();
      renderCatalogo();
    }

    function renderDashboard() {
      const dash = document.getElementById("dashboard");
      const totalUnicos = Object.keys(grupo).length;
      const totalOfertas = precios.length;
      const librerias = [...new Set(precios.map(p => p.libreria))].length;
      const provinciasDetectadas = [...new Set(preciosBase.map(p => normalizarProvincia(p.provincia || "")))].filter(Boolean).length;
      const precioPromedio = precios.length ? (precios.reduce((a, b) => a + b.precio, 0) / precios.length).toFixed(2) : "0.00";
      const precioMin = precios.length ? Math.min(...precios.map(p => p.precio)) : 0;
      const precioMax = precios.length ? Math.max(...precios.map(p => p.precio)) : 0;
      const populares = Object.values(grupo).filter(a => a.length >= 3).length;
      const raros = Object.values(grupo).filter(a => a.length === 1).length;

      const porLibreria = {};
      precios.forEach(l => { if (!porLibreria[l.libreria]) porLibreria[l.libreria] = { s: 0, c: 0 }; porLibreria[l.libreria].s += l.precio; porLibreria[l.libreria].c++; });
      const rankingBaratas = Object.entries(porLibreria).map(([n, d]) => ({ nombre: n, promedio: +(d.s / d.c).toFixed(2), libros: d.c })).sort((a, b) => a.promedio - b.promedio);
      const rankingCaras = [...rankingBaratas].reverse();

      const porProvincia = {};
      preciosBase.forEach(l => {
        const prov = normalizarProvincia(l.provincia || "SIN PROVINCIA");
        if (!porProvincia[prov]) porProvincia[prov] = { s: 0, c: 0, librerias: new Set() };
        porProvincia[prov].s += l.precio;
        porProvincia[prov].c++;
        porProvincia[prov].librerias.add(l.libreria);
      });
      const resumenProvincias = Object.entries(porProvincia).map(([prov, d]) => ({
        provincia: prov,
        promedio: d.c ? d.s / d.c : 0,
        ofertas: d.c,
        librerias: d.librerias.size
      }));
      let conclusionesHtml = "";
      if (resumenProvincias.length > 0) {
        const ordenPorPrecio = [...resumenProvincias].sort((a, b) => a.promedio - b.promedio);
        const ordenPorOfertas = [...resumenProvincias].sort((a, b) => b.ofertas - a.ofertas);
        const masBarataProv = ordenPorPrecio[0];
        const masCaraProv = ordenPorPrecio[ordenPorPrecio.length - 1];
        const masOfertasProv = ordenPorOfertas[0];
        conclusionesHtml = `
          <ul class="insights-list">
            <li><span class="insights-badge">01</span><span>El análisis incluye datos de <strong>${provinciasDetectadas}</strong> provincias con ofertas de libros registradas.</span></li>
            <li><span class="insights-badge">02</span><span><strong>${etiquetaProvincia(masBarataProv.provincia)}</strong> presenta el precio promedio más bajo (~$${masBarataProv.promedio.toFixed(2)}).</span></li>
            <li><span class="insights-badge">03</span><span><strong>${etiquetaProvincia(masCaraProv.provincia)}</strong> concentra los precios promedio más altos (~$${masCaraProv.promedio.toFixed(2)}).</span></li>
            <li><span class="insights-badge">04</span><span>La provincia con más ofertas registradas es <strong>${etiquetaProvincia(masOfertasProv.provincia)}</strong> con ${masOfertasProv.ofertas.toLocaleString()} precios capturados.</span></li>
          </ul>
        `;
      }

      const opcionesProvinciaKpi = ["TODAS", ...provincias].map(p => {
        const codigo = p === "TODAS" ? "TODAS" : normalizarProvincia(p);
        const etiqueta = p === "TODAS" ? "Ecuador completo" : etiquetaProvincia(codigo);
        return `<option value="${codigo}">${etiqueta}</option>`;
      }).join("");

      dash.innerHTML = `
      <div class="kpi-filter-bar">
        <div class="kpi-filter-label">Analizar datos de</div>
        <select id="provinciaKpiSelect" class="provincia-select">
          ${opcionesProvinciaKpi}
        </select>
      </div>

      <div class="kpi-grid">
        <div class="kpi-card"><h3>Libros únicos</h3><p>${totalUnicos.toLocaleString()}</p></div>
        <div class="kpi-card success"><h3>Precio promedio</h3><p>$${precioPromedio}</p></div>
        <div class="kpi-card"><h3>Más barato</h3><p>$${precioMin}</p></div>
        <div class="kpi-card danger"><h3>Más caro</h3><p>$${precioMax}</p></div>
        <div class="kpi-card warning"><h3>Provincias con datos</h3><p>${provinciasDetectadas}</p></div>
      </div>

      <div class="section">
        <h2>Conclusiones rápidas para el trabajo UCE</h2>
        ${conclusionesHtml || `<p style="color:#64748b">Cuando se carguen datos de varias provincias, aquí aparecerá un resumen automático de hallazgos.</p>`}
      </div>

      <div class="section"><h2>Top 15 Libros Más Populares</h2><div class="books-grid" id="topGrid"></div></div>
      <div class="section">
        <div class="section-header-row">
          <h2>Librerías Más Baratas</h2>
          <button class="csv-button" id="csvBaratas">Descargar CSV</button>
        </div>
        <table><thead><tr><th>#</th><th>Librería</th><th>Precio Prom.</th><th>Libros</th></tr></thead><tbody id="baratasBody"></tbody><tr class="ver-mas" id="verMasBaratas"><td colspan="4">Mostrar todas</td></tr></table>
      </div>
      <div class="section"><h2>Librerías Más Caras</h2><table><thead><tr><th>#</th><th>Librería</th><th>Precio Prom.</th><th>Libros</th></tr></thead><tbody id="carasBody"></tbody><tr class="ver-mas" id="verMasCaras"><td colspan="4">Mostrar más</td></tr></table></div>
      <div class="section"><h2>Top 15 Libros Más Baratos</h2><table><thead><tr><th>Título</th><th>Precio</th><th>Librería</th></tr></thead><tbody id="cheapestBody"></tbody><tr class="ver-mas" id="verMasCheapest"><td colspan="3">Ver más ofertas</td></tr></table></div>

      <div class="section">
        <h2>Mapa de librerías por provincia (Google Maps + SRI)</h2>
        <div class="provincia-controls">
          <span class="provincia-label">Vista geográfica:</span>
          <select id="provinciaSelect" class="provincia-select"></select>
        </div>
        <div class="leyenda">
          <strong>Leyenda:</strong><br>
          <span style="color:#1e40af">Marcadores azules</span> → Librerías reales (Google Maps)<br>
          <span style="color:#dc2626">Marcadores rojos</span> → Zonas oficiales del SRI<br>
          <span style="color:#f97316">Marcadores naranjas grandes</span> → Más de 150 establecimientos registrados
        </div>
        <div id="map"></div>

        <!-- COMPARATIVA FINAL CON TOTAL OFICIAL Y EXPANSIÓN -->
        <div class="top-sri-panel">
          <h2>Comparativa Google Maps vs SRI (Datos Oficiales 2025)</h2>
          <div class="kpi-grid" style="margin-bottom:2rem;">
            <div class="kpi-card success"><h3>Librerías en Google Maps</h3><p id="googleCount">0</p></div>
            <div class="kpi-card danger"><h3>Zonas SRI registradas</h3><p id="sriCount">0</p></div>
            <div class="kpi-card danger"><h3>Total establecimientos SRI</h3><p id="totalSRI">0</p></div>
            <div class="kpi-card" id="coberturaCard"><h3>Cobertura real (Google vs SRI)</h3><p id="coberturaPorcentaje">0%</p></div>
          </div>

          <div class="top-sri-inner">
            <strong>Top 10 Zonas con más establecimientos registrados (Datos oficiales SRI)</strong>
            <table>
              <thead><tr><th>#</th><th>Zona / Parroquia</th><th>Establecimientos</th></tr></thead>
              <tbody id="topSRI"></tbody>
            </table>
            <div class="metodologia-footer-row">
              <div class="ver-mas" id="verMasSRI" style="margin-top:1rem;">Ver más zonas</div>
              <button class="csv-button" id="csvTopSRI">Descargar Top SRI CSV</button>
            </div>
          </div>
        </div>
      </div>
      `;

      // (Código de tops y tablas normales igual que antes...)

      Object.entries(grupo).sort((a, b) => b[1].length - a[1].length).slice(0, 15).forEach(([k, v]) => {
        const libro = v[0], min = Math.min(...v.map(x => x.precio));
        document.getElementById("topGrid").innerHTML += `
        <div class="book-card" onclick="abrirModal('${k.replace(/'/g, "\\'")}')">
          <img src="${libro.imagen || defaultImg}" onerror="this.src='${defaultImg}'" loading="lazy">
          <div class="book-info"><h4>${libro.titulo}</h4><div class="price">$${min.toFixed(2)}</div><div class="disponible">En ${v.length} librerías</div></div>
        </div>`;
      });

      rankingBaratas.slice(0, 10).forEach((l, i) => document.getElementById("baratasBody").innerHTML += `<tr><td>${i + 1}</td><td>${l.nombre}</td><td>$${l.promedio}</td><td>${l.libros}</td></tr>`);
      rankingCaras.slice(0, 10).forEach((l, i) => document.getElementById("carasBody").innerHTML += `<tr><td>${i + 1}</td><td>${l.nombre}</td><td>$${l.promedio}</td><td>${l.libros}</td></tr>`);
      precios.slice().sort((a, b) => a.precio - b.precio).slice(0, 15).forEach(l => {
        const t = l.titulo.length > 60 ? l.titulo.substr(0, 60) + '...' : l.titulo;
        document.getElementById("cheapestBody").innerHTML += `<tr><td title="${l.titulo}">${t}</td><td style="color:green;font-weight:bold">$${l.precio.toFixed(2)}</td><td>${l.libreria}</td></tr>`;
      });


      // ==================== VER MÁS DE 10 EN 10 (INTELIGENTE) ====================

      // Librerías Más Baratas
      let offsetBaratas = 10;
      document.getElementById("verMasBaratas").onclick = () => {
        const siguientes = rankingBaratas.slice(offsetBaratas, offsetBaratas + 10);
        siguientes.forEach((l, i) => {
          document.getElementById("baratasBody").innerHTML +=
            `<tr><td>${offsetBaratas + i + 1}</td><td>${l.nombre}</td><td>$${l.promedio}</td><td>${l.libros}</td></tr>`;
        });
        offsetBaratas += 10;

        // Si ya no hay más, elimina el botón
        if (offsetBaratas >= rankingBaratas.length) {
          document.getElementById("verMasBaratas").remove();
        }
      };

      // Librerías Más Caras
      let offsetCaras = 10;
      document.getElementById("verMasCaras").onclick = () => {
        const siguientes = rankingCaras.slice(offsetCaras, offsetCaras + 10);
        siguientes.forEach((l, i) => {
          document.getElementById("carasBody").innerHTML +=
            `<tr><td>${offsetCaras + i + 1}</td><td>${l.nombre}</td><td>$${l.promedio}</td><td>${l.libros}</td></tr>`;
        });
        offsetCaras += 10;

        if (offsetCaras >= rankingCaras.length) {
          document.getElementById("verMasCaras").remove();
        }
      };

      // Libros Más Baratos (ordenados por precio)
      let offsetCheapest = 15;
      document.getElementById("verMasCheapest").onclick = () => {
        const listaOrdenada = [...precios].sort((a, b) => a.precio - b.precio);
        const siguientes = listaOrdenada.slice(offsetCheapest, offsetCheapest + 10);

        siguientes.forEach((l, i) => {
          const tituloCorto = l.titulo.length > 60 ? l.titulo.substr(0, 60) + '...' : l.titulo;
          document.getElementById("cheapestBody").innerHTML +=
            `<tr>
        <td title="${l.titulo}">${tituloCorto}</td>
        <td style="color:green;font-weight:bold">$${l.precio.toFixed(2)}</td>
        <td>${l.libreria}</td>
      </tr>`;
        });

        offsetCheapest += 10;

        // Elimina el botón si ya no quedan más libros
        if (offsetCheapest >= listaOrdenada.length) {
          document.getElementById("verMasCheapest").remove();
        }
      };
      inicializarMapa();

      const btnCSVBaratas = document.getElementById("csvBaratas");
      if (btnCSVBaratas) {
        btnCSVBaratas.onclick = () => {
          const filas = rankingBaratas.map((l, i) => ({
            posicion: i + 1,
            libreria: l.nombre,
            precio_promedio: l.promedio,
            total_libros: l.libros
          }));
          descargarCSVGenerico(filas, "librerias_mas_baratas.csv");
        };
      }

      const selectKpi = document.getElementById("provinciaKpiSelect");
      if (selectKpi) {
        selectKpi.value = provinciaKpi || "TODAS";
        selectKpi.onchange = () => {
          provinciaKpi = selectKpi.value;
          aplicarFiltroKpi();
        };
      }
    }

    function configurarProvinciaSelect() {
      const select = document.getElementById("provinciaSelect");
      if (!select) return;
      const actual = provinciaActiva || "TODAS";
      let opciones = `<option value="TODAS">Ecuador completo</option>`;
      provincias.forEach(p => {
        const codigo = normalizarProvincia(p);
        opciones += `<option value="${codigo}">${etiquetaProvincia(codigo)}</option>`;
      });
      select.innerHTML = opciones;
      select.value = provincias.includes(actual) || actual === "TODAS" ? actual : "TODAS";
      select.onchange = () => {
        provinciaActiva = select.value;
        renderMapa();
      };
    }

    function inicializarMapa() {
      if (mapa) {
        mapa.remove();
        mapa = null;
      }
      mapa = L.map('map').setView([-1.8312, -78.1834], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(mapa);
      capaGoogle = L.layerGroup().addTo(mapa);
      capaSRI = L.layerGroup().addTo(mapa);
      configurarProvinciaSelect();
      fetch('sri_pichincha_pastaza_coordenadas.json')
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(sri => {
          datosSRI = sri;
          renderMapa();
        })
        .catch(() => {
          document.getElementById("sriCount").textContent = "No disponible";
        });
    }

    function renderMapa() {
      if (!mapa || !capaGoogle || !capaSRI) return;
      capaGoogle.clearLayers();
      capaSRI.clearLayers();
      let googleCount = 0;
      const iconGoogle = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] });
      const iconSRI = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] });
      const iconSRIGrande = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', iconSize: [38, 62], iconAnchor: [19, 62], popupAnchor: [1, -50] });
      const puntos = [];
      const filtroProvincia = provinciaActiva && provinciaActiva !== "TODAS" ? provinciaActiva : null;
      ubicaciones.forEach(lib => {
        if (!lib.lat || !lib.lng) return;
        const codigo = normalizarProvincia(lib.provincia || "");
        if (filtroProvincia && codigo !== filtroProvincia) return;
        googleCount++;
        const marcador = L.marker([lib.lat, lib.lng], { icon: iconGoogle }).addTo(capaGoogle);
        marcador.bindPopup(`<b style="color:#1e40af">Librería real (Google)</b><br><b>${lib.nombre || 'Sin nombre'}</b><br>${lib.direccion || ''}`);
        puntos.push([lib.lat, lib.lng]);
      });
      const sriFiltrado = datosSRI.filter(z => {
        if (!z.lat || !z.lng) return false;
        if (!filtroProvincia) return true;
        const codigo = normalizarProvincia(z.DESCRIPCION_PROVINCIA_EST);
        return codigo === filtroProvincia;
      });
      const totalEstablecimientosSRI = sriFiltrado.reduce((a, z) => a + z.TOTAL_SUM_ESTABLECIMIENTOS, 0);
      sriFiltrado.forEach(z => {
        const esGrande = z.TOTAL_SUM_ESTABLECIMIENTOS > 150;
        const zonaNombre = z.DIRECCION.split(',')[0].replace('Quito', '').trim() || 'Zona';
        const marcador = L.marker([z.lat, z.lng], { icon: esGrande ? iconSRIGrande : iconSRI }).addTo(capaSRI);
        marcador.bindPopup(`<div style="font-size:14px"><b style="color:#dc2626">Zona oficial SRI</b><br><b>${zonaNombre}</b><br><hr style="margin:8px 0;border-top:1px solid #eee"><small><b>Establecimientos:</b> ${z.TOTAL_SUM_ESTABLECIMIENTOS}<br><b>Provincia:</b> ${z.DESCRIPCION_PROVINCIA_EST}</small></div>`);
        puntos.push([z.lat, z.lng]);
      });
      const coberturaReal = totalEstablecimientosSRI > 0 ? Math.round((googleCount / totalEstablecimientosSRI) * 100) : 0;
      document.getElementById("googleCount").textContent = googleCount.toLocaleString();
      document.getElementById("sriCount").textContent = sriFiltrado.length + " zonas";
      document.getElementById("totalSRI").textContent = totalEstablecimientosSRI.toLocaleString();
      document.getElementById("coberturaCard").innerHTML = `
                        <h3>Cobertura real (Google vs SRI)</h3>
                        <p style="font-size:2.4rem;color:${coberturaReal < 40 ? '#ef4444' : '#f59e0b'}">${coberturaReal}%</p>
                        <small style="color:#64748b;font-size:0.95rem">
                            ${googleCount} ubicaciones exactas<br>
                            de <strong>${totalEstablecimientosSRI.toLocaleString()}</strong> establecimientos oficiales
                        </small>
                    `;
      const topOrdenado = [...datosSRI].filter(z => {
        if (!filtroProvincia) return true;
        const codigo = normalizarProvincia(z.DESCRIPCION_PROVINCIA_EST);
        return codigo === filtroProvincia;
      }).sort((a, b) => b.TOTAL_SUM_ESTABLECIMIENTOS - a.TOTAL_SUM_ESTABLECIMIENTOS);
      const mostrarTop = (hasta = 10) => {
        document.getElementById("topSRI").innerHTML = topOrdenado.slice(0, hasta).map((z, i) => {
          const nombre = z.DIRECCION.split(',')[0].replace('Quito', '').trim() || 'Zona';
          return `<tr><td>${i + 1}</td><td>${nombre}</td><td><strong>${z.TOTAL_SUM_ESTABLECIMIENTOS}</strong></td></tr>`;
        }).join("");
      };
      mostrarTop(10);
      const verMas = document.getElementById("verMasSRI");
      if (verMas) {
        verMas.onclick = () => {
          mostrarTop(1000);
          verMas.remove();
        };
      }
      const btnSRI = document.getElementById("csvTopSRI");
      if (btnSRI) {
        btnSRI.onclick = () => {
          const filas = topOrdenado.map((z, i) => ({
            posicion: i + 1,
            zona: z.DIRECCION,
            provincia: z.DESCRIPCION_PROVINCIA_EST,
            establecimientos: z.TOTAL_SUM_ESTABLECIMIENTOS
          }));
          descargarCSVGenerico(filas, "top_sri.csv");
        };
      }
      if (puntos.length > 0) {
        mapa.fitBounds(puntos, { padding: [50, 50] });
      }
    }

    // CATÁLOGO, MODAL y funciones openTab igual que antes...
    function renderCatalogo() {
      const opcionesProvincia = provincias.length
        ? provincias.map(p => `<option value="${p}">${etiquetaProvincia(p)}</option>`).join("")
        : "";
      document.getElementById("catalogo").innerHTML = `<div class="section"><h2>Catálogo Completo (${Object.keys(grupo).length} libros únicos)</h2><div class="catalogo-filtros"><input type="text" class="table-search" id="searchCat" placeholder="Buscar libro, autor, editorial..." onkeyup="filtrarCat()"><select id="provinciaCat" class="provincia-select" onchange="filtrarCat()"><option value="TODAS">Todas las provincias</option>${opcionesProvincia}</select></div><div class="books-grid" id="catGrid"></div></div>`;
      mostrarTodos();
    }
    function mostrarTodos() {
      const g = document.getElementById("catGrid"); g.innerHTML = "";
      Object.entries(grupo).forEach(([k, v]) => {
        const libro = v[0], min = Math.min(...v.map(x => x.precio));
        g.innerHTML += `<div class="book-card" onclick="abrirModal('${k.replace(/'/g, "\\'")}')">
          <img src="${libro.imagen || defaultImg}" onerror="this.src='${defaultImg}'" loading="lazy">
          <div class="book-info"><h4>${libro.titulo}</h4><div class="price">$${min.toFixed(2)}</div><div class="disponible">En ${v.length} librerías</div></div>
        </div>`;
      });
    }
    function filtrarCat() {
      const t = document.getElementById("searchCat").value.toLowerCase();
      const g = document.getElementById("catGrid"); g.innerHTML = "";
      const selectProvincia = document.getElementById("provinciaCat");
      const filtroProvincia = selectProvincia ? selectProvincia.value : "TODAS";
      Object.entries(grupo)
        .filter(([k, _]) => k.toLowerCase().includes(t))
        .filter(([_, v]) => {
          if (!filtroProvincia || filtroProvincia === "TODAS") return true;
          const setProv = new Set(v.map(x => normalizarProvincia(x.provincia || "")));
          return setProv.has(filtroProvincia);
        })
        .forEach(([k, v]) => {
          const libro = v[0], min = Math.min(...v.map(x => x.precio));
          g.innerHTML += `<div class="book-card" onclick="abrirModal('${k.replace(/'/g, "\\'")}')">
          <img src="${libro.imagen || defaultImg}" onerror="this.src='${defaultImg}'" loading="lazy">
          <div class="book-info"><h4>${libro.titulo}</h4><div class="price">$${min.toFixed(2)}</div><div class="disponible">En ${v.length} librerías</div></div>
        </div>`;
        });
    }

    let modalData = [];
    function abrirModal(clave) {
      modalData = grupo[clave];
      document.getElementById("modalTitulo").textContent = modalData[0].titulo;
      renderModal();
      document.getElementById("modal").style.display = "block";
    }
    function renderModal() {
      let d = [...modalData];
      const o = document.getElementById("modalOrder").value;
      if (o === "precio-asc") d.sort((a, b) => a.precio - b.precio);
      if (o === "precio-desc") d.sort((a, b) => b.precio - a.precio);
      const f = document.getElementById("modalSearch").value.toLowerCase();
      if (f) d = d.filter(l => l.libreria.toLowerCase().includes(f));
      document.getElementById("modalBody").innerHTML = d.map(l => `<tr><td>${l.libreria}</td><td style="color:#10b981;font-weight:700">$${l.precio.toFixed(2)}</td><td>Disponible</td></tr>`).join("");
    }
    function filtrarModal() { renderModal(); }
    function ordenarModal() { renderModal(); }

    function openTab(id) {
      document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      document.querySelector(`[onclick="openTab('${id}')"]`).classList.add("active");
    }

    function descargarCSVGenerico(filas, nombre) {
      if (!filas || !filas.length) return;
      const encabezados = Object.keys(filas[0]);
      const lineas = [];
      lineas.push(encabezados.join(";"));
      filas.forEach(f => {
        lineas.push(encabezados.map(c => {
          const valor = f[c] == null ? "" : String(f[c]).replace(/"/g, '""');
          return `"${valor}"`;
        }).join(";"));
      });
      const blob = new Blob([lineas.join("\n")], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = nombre;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function togglePresentacion() {
      document.body.classList.toggle("presentation");
    }

    cargarDatos();
  </script>
</body>

</html>
